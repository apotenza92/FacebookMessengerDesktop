name: Cleanup Workflow Runs

on:
  schedule:
    # Run daily at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Delete cancelled and failed runs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get all completed runs
            const allRuns = await github.paginate(
              github.rest.actions.listWorkflowRunsForRepo,
              { owner, repo, per_page: 100 }
            );
            
            // Filter to only completed runs with cancelled or failure conclusion
            const runsToDelete = allRuns.filter(run => 
              run.status === 'completed' && 
              (run.conclusion === 'cancelled' || run.conclusion === 'failure')
            );
            
            console.log(`Found ${runsToDelete.length} cancelled/failed runs to delete`);
            console.log(`Skipping ${allRuns.length - runsToDelete.length} runs (in progress, queued, or successful)`);
            
            for (const run of runsToDelete) {
              try {
                await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                console.log(`Deleted ${run.conclusion} run ${run.id}`);
              } catch (e) {
                console.log(`Failed to delete run ${run.id}: ${e.message}`);
              }
            }
