name: Cleanup Workflow Runs

on:
  schedule:
    # Run daily at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Delete cancelled runs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get cancelled runs
            const cancelledRuns = await github.paginate(
              github.rest.actions.listWorkflowRunsForRepo,
              { owner, repo, status: 'cancelled', per_page: 100 }
            );
            
            console.log(`Found ${cancelledRuns.length} cancelled runs`);
            
            for (const run of cancelledRuns) {
              try {
                await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                console.log(`Deleted cancelled run ${run.id}`);
              } catch (e) {
                console.log(`Failed to delete run ${run.id}: ${e.message}`);
              }
            }

      - name: Delete failed runs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get failed runs
            const failedRuns = await github.paginate(
              github.rest.actions.listWorkflowRunsForRepo,
              { owner, repo, status: 'failure', per_page: 100 }
            );
            
            console.log(`Found ${failedRuns.length} failed runs`);
            
            for (const run of failedRuns) {
              try {
                await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                console.log(`Deleted failed run ${run.id}`);
              } catch (e) {
                console.log(`Failed to delete run ${run.id}: ${e.message}`);
              }
            }
